{"version":3,"sources":["..\\..\\..\\..\\..\\assets\\cases\\07_render_texture/assets\\cases\\07_render_texture\\render_to_canvas.js"],"names":["cc","Class","extends","Component","properties","camera","default","type","Camera","start","texture","RenderTexture","gl","game","_renderContext","initWithSize","visibleRect","width","height","STENCIL_INDEX8","targetTexture","capture","canvas","document","createElement","ctx","getContext","render","data","readPixels","rowBytes","row","srow","imageData","createImageData","i","putImageData","dataURL","toDataURL","img","src","captureAndShow","Texture2D","initWithElement","spriteFrame","SpriteFrame","setTexture","node","Node","sprite","addComponent","Sprite","zIndex","macro","MAX_ZINDEX","parent","director","getScene","x","winSize","y","on","EventType","TOUCH_START"],"mappings":"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","file":"render_to_canvas.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\cases\\07_render_texture","sourcesContent":["cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        camera: {\n            default: null,\n            type: cc.Camera\n        }\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n\n    // onLoad () {},\n\n    start () {\n        let texture = new cc.RenderTexture();\n        let gl = cc.game._renderContext;\n        texture.initWithSize(cc.visibleRect.width, cc.visibleRect.height, gl.STENCIL_INDEX8);\n        this.camera.targetTexture = texture;\n        this.texture = texture;\n    },\n\n    capture () {\n        let width = this.texture.width;\n        let height = this.texture.height;\n\n        let canvas = document.createElement('canvas');\n        let ctx = canvas.getContext('2d');\n        canvas.width = width;\n        canvas.height = height;\n\n        this.camera.render();\n        let data = this.texture.readPixels();\n        \n        let rowBytes = width * 4;\n        for (let row = 0; row < height; row++) {\n            let srow = height - 1 - row;\n            let imageData = ctx.createImageData(width, 1);\n            let start = srow*width*4;\n            for (let i = 0; i < rowBytes; i++) {\n                imageData.data[i] = data[start+i];\n            }\n\n            ctx.putImageData(imageData, 0, row);\n        }\n\n        var dataURL = canvas.toDataURL(\"image/jpeg\");\n        var img = document.createElement(\"img\");\n        img.src = dataURL;\n        return img;\n    },\n\n    captureAndShow () {\n        var img = this.capture();\n\n        // You can save the image or show it.\n\n        // img.style.position = 'absolute';\n        // img.style.display = 'block';\n        // img.style.left = '0px'\n        // img.style.top = '0px';\n        // img.zIndex = 100;\n\n        // img.style.transform = cc.game.container.style.transform;\n        // img.style['transform-origin'] = cc.game.container.style['transform-origin'];\n        // img.style.margin = cc.game.container.style.margin;\n        // img.style.padding = cc.game.container.style.padding;\n\n        // img.onclick = function (event) {\n        //     event.stopPropagation();\n        //     img.remove();\n        // }\n\n        // document.body.appendChild(img);\n\n        let texture = new cc.Texture2D();\n        texture.initWithElement(img);\n\n        let spriteFrame = new cc.SpriteFrame();\n        spriteFrame.setTexture(texture);\n\n        let node = new cc.Node();\n        let sprite = node.addComponent(cc.Sprite);\n        sprite.spriteFrame = spriteFrame;\n\n        node.zIndex = cc.macro.MAX_ZINDEX;\n        node.parent = cc.director.getScene();\n        node.x = cc.winSize.width/2;\n        node.y = cc.winSize.height/2;\n        node.on(cc.Node.EventType.TOUCH_START, () => {\n            node.parent = null;\n        });\n    }\n\n    // update (dt) {},\n});\n"]}